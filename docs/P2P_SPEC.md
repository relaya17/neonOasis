# תיקון למסמך האפיון: ממעטפת משחקית לפלטפורמת P2P

**הקשר:** שומרים על Frontend ו-Visuals (ניאון, 3D, פיד טיקטוק, AI Guardian) — "חלון הראווה".  
**השינוי:** Backend עובר ממודל "שחקן נגד הבית" (Social Casino) ל-**P2P Skill-Economy**.

---

## 1. שלושת העקרונות בליבה

### 1.1 הארנק כציר מרכזי (Wallet-Centric)

- **Ledger (יומן פעולות):** כל תנועת מטבע מתועדת — אין עדכון balance בלי רשומת transaction.
- **P2P Transfer:** השרת מעביר יתרה מארנק משתמש א' לארנק משתמש ב' בסיום משחק (Settlement).

### 1.2 מנגנון Escrow (נאמנות בזמן אמת)

- עם **התחלת משחק:** השרת מבצע **Hold** (נעילה) על סכום ההתערבות משני הארנקים.
- הכסף **לא** עובר לבית — "יושב בצד" עד שהשרת **מאמת מנצח** (Server-side validation) ואז מחלק קופה (פחות עמלה).

### 1.3 כריית יכולת והנפקת Oasis Token

- בכל **ניצחון/הישג:** המערכת **מנפיקה (Mint)** למשתמש מטבעות Oasis Token.
- לא סתם עדכון DB — פונקציה בשרת שבודקת עמידה בתנאים (ניצחון/יכולת) ומייצרת נכס דיגיטלי לצבירה/טורנירים.

---

## 2. ארבע התיקונים הטכניים (חובה למתכנת)

| # | כלל | תיאור |
|---|-----|--------|
| 1 | **State Sync** | השרת הוא **Source of Truth** לכל מהלך — מונע זיופי מטבעות. |
| 2 | **Transactions** | כל משחק = **טרנזקציית DB אטומית:** נעילת כספים → משחק → חלוקת זכייה + גביית עמלה. |
| 3 | **Modular Games** | ארנק P2P הוא **שירות נפרד** (Microservice); כל משחק (שש-בש, פוקר, שחמט) רק "מתחבר" אליו. |
| 4 | **Anti-Fraud** | **Log** של כתובות IP וזמני משחק — למניעת "מכירת משחקים" (Chip Dumping). |

---

## 3. המנוע הכלכלי (P2P Engine & Tokenomics)

- **ארנק P2P:** כסף עובר **ישירות** משחקן א' לשחקן ב' בסיום משחק.
- **Smart Escrow:** בתחילת סיבוב — נעילה; רק אחרי אישור מנצח — שחרור + חלוקה.
- **Platform Fee:** עמלה קבועה (למשל 5%–10%) מכל העברה בין שחקנים.
- **Oasis Token:** מטבע פנימי ששחקנים "כורים" דרך ניצחונות; לשימוש בטורנירים וחנות; מבנה מוכן למעבר עתידי ל-Blockchain.

---

## 4. ארבע השכבות שהמתכנת בונה

| שכבה | תוכן |
|------|------|
| **UI/UX** | React 18 + Framer Motion (ניאון, אנימציות) — ללא שינוי. |
| **Game Logic** | Node.js + Socket.io (סנכרון משחקים בזמן אמת). |
| **Financial** | ניהול ארנקים, Ledger, Escrow (נעילה/שחרור), P2P Settlement, Oasis Mint. |
| **Geo-Logic** | סינון משחקים לפי מיקום (ישראל = משחקי יכולת בלבד). |

---

## 5. למה הקודם לא "מתבטל"

**הקודם = ה"מה"** (שש-בש בוגאס, פיד, ניאון).  
**השינוי = ה"איך"** (כלכלה בין שחקנים).  
ה-UI נשאר אותו דבר — הכפתורים מפעילים מערכת סליקה P2P (Escrow + Settlement + Oasis).

---

---

## 6. התקנה (למתכנת)

1. **מיגרציה:** הרץ את מיגרציה 004 על ה-DB הקיים:
   ```bash
   psql $DATABASE_URL -f apps/api/src/db/migrations/004_p2p_escrow_oasis_ledger.sql
   ```
2. **API:** `POST /api/games/p2p/start` — התחלת משחק P2P (Escrow + Anti-Fraud).  
   `POST /api/games/p2p/end` — סיום משחק (Settlement + Oasis Mint).
3. **Socket:** אירועים `p2p:match_start`, `p2p:match_end` — משחקים מתחברים דרך Socket או HTTP.

---

**מסמך זה הוא תיקון/addendum ל-PRD הראשי.**  
**גרסה:** 1.0 | **תאריך:** פברואר 2026
