<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>חילוץ כדורי סנוקר — כל כדור בנפרד</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 20px; background: #1a1a2e; color: #eee; max-width: 900px; margin: 0 auto; }
    h1 { color: #00f5d4; }
    .info { background: rgba(0,245,212,0.1); border: 1px solid #00f5d4; border-radius: 8px; padding: 12px; margin: 16px 0; }
    button { background: #00f5d4; color: #1a1a2e; border: none; padding: 12px 24px; font-size: 1rem; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 8px 8px 8px 0; }
    button:hover { background: #00c4a7; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #preview { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 20px; }
    .ball-preview { text-align: center; }
    .ball-preview canvas { display: block; border-radius: 50%; background: #333; margin: 0 auto 4px; }
    .ball-preview a { font-size: 0.85rem; color: #00f5d4; }
  </style>
</head>
<body>
  <h1>חילוץ כדורי סנוקר — כל כדור בנפרד</h1>
  <div class="info">
    הדף טוען את גיליון הכדורים, חותך כל כדור לפי הסט של סנוקר (לבן, אדום, צהוב, ירוק, חום, כחול, ורוד, שחור),
    הופך רקע לבן לשקוף, ומאפשר הורדת כל כדור כ־PNG.<br>
    <strong>שימוש:</strong> הרץ <code>pnpm dev</code>, פתח בדפדפן <strong>/extract-snooker-balls.html</strong>, לחץ "טען גיליון וחלץ כדורים", ואז "הורד את כל הכדורים". שמור את 8 הקבצים בתיקייה <code>apps/web/public/images/</code> (שמות: snooker_ball_white.png, snooker_ball_red.png וכו').
  </div>
  <button id="loadBtn">טען גיליון וחלץ כדורים</button>
  <div id="preview"></div>

  <script>
    const SHEET_URL = '/images/snooker_balls_sheet.png';
    const COLS = 8;
    const ROWS = 5;
    const WHITE_THRESHOLD = 248;

    // מיפוי סוג כדור סנוקר → [עמודה, שורה] (0-based) בגיליון 8x5
    const SNOOKER_BALLS = {
      white:  [0, 0],
      red:    [1, 0],
      yellow: [2, 1],
      green:  [1, 1],
      brown:  [3, 1],
      blue:   [6, 0],
      pink:   [0, 3],
      black:  [5, 1],
    };

    function makeTransparent(img, sx, sy, cw, ch) {
      const c = document.createElement('canvas');
      c.width = cw;
      c.height = ch;
      const ctx = c.getContext('2d');
      ctx.drawImage(img, sx, sy, cw, ch, 0, 0, cw, ch);
      const data = ctx.getImageData(0, 0, cw, ch);
      const d = data.data;
      for (let i = 0; i < d.length; i += 4) {
        const r = d[i], g = d[i + 1], b = d[i + 2];
        if (r >= WHITE_THRESHOLD && g >= WHITE_THRESHOLD && b >= WHITE_THRESHOLD)
          d[i + 3] = 0;
      }
      ctx.putImageData(data, 0, 0);
      return c;
    }

    function downloadCanvas(canvas, name) {
      const a = document.createElement('a');
      a.download = name;
      a.href = canvas.toDataURL('image/png');
      a.click();
    }

    document.getElementById('loadBtn').onclick = async function () {
      const btn = this;
      btn.disabled = true;
      btn.textContent = 'טוען...';
      const preview = document.getElementById('preview');
      preview.innerHTML = '';

      const img = new Image();
      img.crossOrigin = 'anonymous';
      await new Promise((resolve, reject) => {
        img.onload = resolve;
        img.onerror = () => reject(new Error('טעינת התמונה נכשלה'));
        img.src = SHEET_URL;
      });

      const cw = Math.floor(img.naturalWidth / COLS);
      const ch = Math.floor(img.naturalHeight / ROWS);

      const results = {};
      for (const [type, [col, row]] of Object.entries(SNOOKER_BALLS)) {
        const sx = col * cw;
        const sy = row * ch;
        const ballCanvas = makeTransparent(img, sx, sy, cw, ch);
        results[type] = ballCanvas;
      }

      btn.textContent = 'הורד את כל הכדורים (8 קבצים)';
      btn.disabled = false;
      btn.onclick = () => {
        Object.entries(results).forEach(([type, canvas]) => {
          downloadCanvas(canvas, `snooker_ball_${type}.png`);
        });
      };

      // תצוגה מקדימה
      Object.entries(results).forEach(([type, canvas]) => {
        const wrap = document.createElement('div');
        wrap.className = 'ball-preview';
        const c2 = document.createElement('canvas');
        c2.width = 64;
        c2.height = 64;
        c2.getContext('2d').drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, 64, 64);
        wrap.appendChild(c2);
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = `snooker_ball_${type}.png`;
        link.textContent = `הורד ${type}`;
        link.style.display = 'inline-block';
        link.style.marginTop = '4px';
        wrap.appendChild(link);
        preview.appendChild(wrap);
      });
    };
  </script>
</body>
</html>
